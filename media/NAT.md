# NAT
NAT（Network Address Translation，网络地址转换）简单来说就是为了`解决IPV4下的IP地址匮乏`和`保护网内主机`而出现的一种技术。  
NAT通常部署在一个组织的网络出口位置，替换IP报文头部的地址信息。在报文离开私网进入Internet时，将源IP替换为公网地址，通常是出口设备的接口地址。一个对外的访问请求在到达目标以后，表现为由本组织出口设备发起，因此被请求的服务端可将响应由Internet发回出口网关。出口网关再将目的地址替换为私网的源主机地址，发回内部。

*  双向流量必须都要经过NAT网关
*  网络访问只能先由私网侧发起，公网无法主动访问私网主机
*  NAT网关为了实现双向翻译的功能，需要维护一张关联表，把会话的信息保存下来


## 一对多的NAT
当有多个内部主机去访问同一个服务器时，从返回的信息不足以区分响应应该转发到哪个内部主机。   
此时，需要NAT设备根据传输层信息或其他上层协议去区分不同的会话，并且可能要对上层协议的标识进行转换，比如TCP或UDP端口号。   
**这样NAT网关就可以将不同的内部连接访问映射到同一公网IP的不同传输层端口。**


### 按照NAT端口映射方式分类
#### 全锥形NAT
其特点为：一旦内部主机端口对(iAddr:iPort)被NAT网关映射到(eAddr:ePort)，所有后续的(iAddr:iPort)报文都会被转换为(eAddr:ePort)；`任何一个外部主机`发送到(eAddr:ePort)的报文将会被转换后发到(iAddr:iPort)。

#### 限制锥形NAT
其特点为：一旦内部主机端口对(iAddr:iPort)被映射到(eAddr:ePort)，所有后续的(iAddr:iPort)报文都会被转换为(eAddr:ePort)；只有 (iAddr:iPort)向特定的外部主机hAddr`发送过数据`，**主机hAddr从`任意端口`**发送到(eAddr:ePort)的报文将会被转发到(iAddr:iPort)。

#### 端口限制锥形NAT
其特点为：一旦内部主机端口对(iAddr:iPort)被映射到(eAddr:ePort)，所有后续的(iAddr:iPort)报文都会被转换为(eAddr:ePort)；只有(iAddr:iPort)向特定的外部主机端口对(hAddr:hPort)`发送过数据`，`由 (hAddr:hPort)发送`到(eAddr:ePort)的报文将会被转发到(iAddr:iPort)。

#### 对称型NAT
其特点为：NAT网关会把内部主机“地址端口对”和外部主机“地址端口对”完全相同的报文看作一个连接，在网关上创建一个**公网“地址端口对”映射**进行转换，**只有收到报文的外部主机从对应的端口对发送回应的报文，才能被转换**。即使内部主机使用之前用过的地址端口对去连接不同外部主机(或端口)时，NAT网关也会建立新的映射关系。

## NAT的弊端




## NAT保护
NAT技术会保护内网地址的安全性，所以这就会引发个问题，就是当我采用P2P之中连接方式的时候，NAT会阻止外网地址的访问，这时我们就得采用NAT穿透了。

## NAT穿越
我们借助一个公网IP服务器,a,b都往公网IP/PORT发包,公网服务器就可以获知a,b的IP/PORT，又由于a,b主动给公网IP服务器发包，所以公网服务器可以穿透NAT A,NAT B送包给a,b。
所以只要公网IP将b的IP/PORT发给a,a的IP/PORT发给b。这样下次a和b互相消息，就不会被NAT阻拦了。