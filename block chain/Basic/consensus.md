# 共识机制
## 分布式一致性与共识
区块链的本质就是一个分布式系统，而分布式系统通常面临了几个问题：一致性问题，可终止性问题、合法性问题。

可终止性可以理解为系统必须在有限的时间内给出一致性结果，合法性是指提案必须是系统内的节点提出。当然其中面对的最重要也是最基础的问题，就是我们常说的**一致性**问题。

一致性是指在某个分布式系统中，多个服务节点呈现相同的状态和数据。这里面可能是多个相同的服务提供同样的功能，那么这些服务中的状态和数据就应该保持一致，对外就好像一个服务一样；另一种情况是多个不同的服务在提供不同的功能，但他们的数据前后关联，那么这些服务所拥有的数据也应该保持一致。但是很多时候，我们不可能要求所有服务器100%都达成一致状态，只要超过半数的大多数服务器达成一致就可以了，假设有N台服务器，N/2 +1 就超过半数，代表大多数了。所以一致性也分严格一致性、最终一致性。

对应到区块链系统中就可以表示为：任意节点的提案能够在约定的协议下被其他所有节点所认可。因为区块链系统中不分服务端和客户端，所以这里强调任意节点，同时上文所说的一致性在这里就对应为区块链的共识机制。需要提醒你区分的一点是：这里的“认可”表示所有节点对外呈现的信息一致，而不是对信息的内容认可。

## 常见算法
常见的分布式一致性算法有[ref](https://github.com/yjjnls/Notes/blob/master/distribute/distribute.md)，其中paxos和raft协议是较为经典的算法，但是他们无法抵御节点恶意篡改数据的攻击，所以常用于节点能够完全信任的环境，比如各节点服务都是某公司统一部署控制的，节点完全私有。这种情况属于中心化的分布式系统，一般会有leader，系统可以容忍非恶意攻击，例如网络拥堵、数据丢失等等，但不能容忍恶意结点的攻击。而区块链的应用环境恰恰是其他两种情况，第一种是完全公有的环境，也即公链，任何人都可以部署节点，常用PoW、POS等共识算法；而第二种是属于私有链，只有获得许可的机构或者个人才能部署节点，参与的机构或者个人由于先获得了权限许可，所以可以看作“可信任”。这里的“可信任”是指受信程度高于完全陌生的公有节点，但也不是完全可以信任。这种情况通常用PBFT算法（拜占庭将军问题，在有恶意节点的情况下（精神分裂式投票），如何保证系统状态与数据的一致性）。

### PoW
PoW 全称 Proof of Work，也即工作量证明，由于比特币中所使用的共识机制就是PoW，因此PoW的概念传播最为广泛。但PoW机制最早在1977年就被提出应用在抵抗滥用软件服务的场景中，例如在抵抗垃圾邮件的场景中，接收者并不直接接受来自任意发送者的消息，发送者需要计算一个按照规则约定难题的答案，发送给接受者的同时，需要附带验证这个答案，如果这个答案被验证有效，那么接受者才会接受这个消息。而这个难题答案的验证过程是非常容易的，这种特性我们称之为计算不对称特性，即破解很难，但是验证很容易。通过这一例子说明也能让我们更好地理解PoW的设计思想。   

在比特币系统中，会要求对每个区块头中的信息求哈希值，如果得到的哈希值前十位都为0，那么这个区块头才是有效的。而区块头中包含一个随机数，所谓挖矿就是不断探测这个随机值，使其计算得到的哈希值满足条件，找到满足条件的随机值之后再将区块广播出去。其他区块在收到这条广播信息之后，先验证这一哈希条件是否满足，如果不满足直接丢弃。PoW使得区块在验证的时候非常容易，而在寻找随机数时毫无规律，只能重复机械地尝试，且要求的哈希值的0开头的位数越多，随机数寻找难度越大。而这重复地寻找过程和实体电力成本又成正比。

#### PoW挖矿
PoW的过程就是计算一个难题解的过程，而在比特币中，解决了这个难题，就有一定概率获得一定量的比特币作为奖励，所以称之为挖矿。  

中本聪设计比特币时，其愿景是1 CPU一票，也就相当于1个CPU等于一个矿工，这样比特币的记账就能平均分布到全世界。但是CPU着重控制逻辑，而挖矿过程是一种简单的重复计算，所以后面又发展出了GPU并行挖矿，效率能够提升几十倍甚至上百倍。后续又出现了FPGA挖矿，和专业的矿机挖矿，使得挖矿效率不断提高。

但是按照中本聪的设计，比特币应该是一个去中心化的分布式系统，但随着挖矿设备的不断进阶，挖矿门槛其实越来越高。CPU挖矿时代，只要你有一台电脑就可以挖；到了GPU挖矿，你得有好的显卡；而使用专业矿机，其购买、维护成本都大大提升，配置、使用门槛也不像使用PC那样低。此时如果再用CPU来挖矿，那么挖矿成功率简直可以忽略不计，而且专业矿机的电力损耗也非普通用户所能承受。**所以，比特币慢慢演化成了中心化的挖矿，出现了大的矿池。** 矿池对外依然是一个挖矿节点，但是集合了来自各方的算力（可以是不同矿机，或者不同用户的PC），由于算力的提升，其挖矿成功率大大提升，获取比特币后再根据算力贡献来分配比特币。

#### PoW优缺点
PoW的一个最大的缺点就是电力浪费，但也是这一特点，把经济博弈引入了区块链的防篡改机制，比如比特币会有 51% 算力攻击的问题，即攻击者只需要购买超过全网 51% 算力设备，即可发起“双花攻击”，甚至“重放攻击”等多种高收益攻击。这么做从技术角度来说篡改了区块链，但是从经济上来说确实无利可图，所以这反而使PoW反而成为一个可靠的共识机制。

除了 51% 攻击，PoW 共识还有自私挖矿的问题，自私挖矿是一种特殊的攻击类型，不会影响区块链正常运转，但是会形成矿霸，间接造成 51% 攻击，我们就曾经遇到过这样的自私挖矿攻击。
（自私挖矿是指矿工先通过较大算力积累优势，挖出多的块的同时不广播，等别人广播一个新区块的时候，自己一下广播2个甚至更多区块，让别人一直处于被分分叉的状态，自己成为矿霸，可以形成100%出块率。）

PoW 共识机制是一种简单粗暴的共识算法，它不要求高质量的 P2P 网络资源，它可以为公链提供稳定有效的记账者筛选机制。同时它也面临了挖矿中心化严重的问题，这也促使人们研究出了新的共识机制。

### PoS
PoS 全称是 Proof of Stake，也即权益证明，最早出现在点点币的创始人 Sunny King 的白皮书中，它的目的就是为了解决使用 PoW 挖矿出现大量资源浪费的问题。

在讲 PoS 之前，我先来讲一个叫做币龄的概念，币龄这个概念其实很好理解，它的英文是 CoinAge，字面意思就是币数量乘以天数。

比如你有 100 个币，在某个地址上 9 天没有动，那么产生的币龄就是 900，如果你把这个地址上这 100 币转移到任意地址，包括你自己的地址，那么 900 个币龄就在转移过程中被花费了，你的币数量虽然还是 100 个，但是币龄变更为 0。币龄在数据链上就可以取到，任何人都可以验证。

我们回过头来看看 PoS 究竟是什么，区块链共识机制的第一步就是随机筛选一个记账者，PoW 是通过计算能力来获得记账权，计算能力越强，获得记账权的概率越大。

PoS 则将此处的计算能力更换为财产证明，就是节点所拥有的币龄越多，获得的记账的概率就越大。这有点像公司的股权结构，股权占比大的合伙人话语权越重。

以上算是简述了 PoS 的概念，实际上，PoS 的发展经历了三个版本，第一个版本是以点点币为代币的 PoS1.0 版本，这个版本中使用的是币龄；第二个版本为代表的是黑币（blackcoin），它使用的为 PoS2.0 版本，对应这个版本使用的是币数量，相当于是财产证明，后面黑币又升级到 PoS3.0，这个版本又回到了币龄。

PoW 早在比特币出现之前就已经应用了，而 PoS 是才是真正意义上为了区块链而创造出来的概念。