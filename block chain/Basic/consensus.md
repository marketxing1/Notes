# 共识机制
## 分布式一致性与共识
区块链的本质就是一个分布式系统，而分布式系统通常面临了几个问题：一致性问题，可终止性问题、合法性问题。

可终止性可以理解为系统必须在有限的时间内给出一致性结果，合法性是指提案必须是系统内的节点提出。当然其中面对的最重要也是最基础的问题，就是我们常说的**一致性**问题。

一致性是指在某个分布式系统中，多个服务节点呈现相同的状态和数据。这里面可能是多个相同的服务提供同样的功能，那么这些服务中的状态和数据就应该保持一致，对外就好像一个服务一样；另一种情况是多个不同的服务在提供不同的功能，但他们的数据前后关联，那么这些服务所拥有的数据也应该保持一致。但是很多时候，我们不可能要求所有服务器100%都达成一致状态，只要超过半数的大多数服务器达成一致就可以了，假设有N台服务器，N/2 +1 就超过半数，代表大多数了。所以一致性也分严格一致性、最终一致性。

对应到区块链系统中就可以表示为：任意节点的提案能够在约定的协议下被其他所有节点所认可。因为区块链系统中不分服务端和客户端，所以这里强调任意节点，同时上文所说的一致性在这里就对应为区块链的共识机制。需要提醒你区分的一点是：这里的“认可”表示所有节点对外呈现的信息一致，而不是对信息的内容认可。

## 常见算法
常见的分布式一致性算法有[ref](https://github.com/yjjnls/Notes/blob/master/distribute/distribute.md)，其中paxos和raft协议是较为经典的算法，但是他们无法抵御节点恶意篡改数据的攻击，所以常用于节点能够完全信任的环境，比如各节点服务都是某公司统一部署控制的，节点完全私有。这种情况属于中心化的分布式系统，一般会有leader，系统可以容忍非恶意攻击，例如网络拥堵、数据丢失等等，但不能容忍恶意结点的攻击。而区块链的应用环境恰恰是其他两种情况，第一种是完全公有的环境，也即公链，任何人都可以部署节点，常用POW、POS等共识算法；而第二种是属于私有链，只有获得许可的机构或者个人才能部署节点，参与的机构或者个人由于先获得了权限许可，所以可以看作“可信任”。这里的“可信任”是指受信程度高于完全陌生的公有节点，但也不是完全可以信任。这种情况通常用PBFT算法（拜占庭将军问题，在有恶意节点的情况下（精神分裂式投票），如何保证系统状态与数据的一致性）。

### POW
PoW 全称 Proof of Work，也即工作量证明，由于比特币中所使用的共识机制就是POW，因此POW的概念传播最为广泛。但POW机制最早在1977年就被提出应用在抵抗滥用软件服务的场景中，例如在抵抗垃圾邮件的场景中，接收者并不直接接受来自任意发送者的消息，发送者需要计算一个按照规则约定难题的答案，发送给接受者的同时，需要附带验证这个答案，如果这个答案被验证有效，那么接受者才会接受这个消息。而这个难题答案的验证过程是非常容易的，这种特性我们称之为计算不对称特性，即破解很难，但是验证很容易。通过这一例子说明也能让我们更好地理解POW的设计思想。   

在比特币系统中，会要求对每个区块头中的信息求哈希值，如果得到的哈希值前十位都为0，那么这个区块头才是有效的。而区块头中包含一个随机数，所谓挖矿就是不断探测这个随机值，使其计算得到的哈希值满足条件，找到满足条件的随机值之后再将区块广播出去。其他区块在收到这条广播信息之后，先验证这一哈希条件是否满足，如果不满足直接丢弃。POW使得区块在验证的时候非常容易，而在寻找随机数时毫无规律，只能重复机械地尝试，且要求的哈希值的0开头的位数越多，随机数寻找难度越大。而这重复地寻找过程和实体电力成本又成正比。