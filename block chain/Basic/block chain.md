# BitCoin
## 时间戳服务器(Timestamp server)
* 时间戳服务器通过对`以区块(block)形式`存在的一组数据实施随机散列而加上时间戳，并将该随机散列进行广播。
* 该时间戳能够证实特定数据必然于某特定时间是的确存在的，因为只有在该时刻存在了才能获取相应的随机散列值。
* 每个时间戳应当将前一个时间戳纳入其随机散列值中，每一个随后的时间戳都对之前的一个时间戳进行增强(reinforcing)，这样就形成了一个`链条(Chain)`。

## 工作量证明（Proof-of-Work）
>在区块中补增一个随机数(Nonce)，这个随机数要使得该给定区块的随机散列值出现了所需的那么多个0。我们通过反复尝试来找到这个随机数，直到找到为止，这样我们就构建了一个工作量证明机制。  

区块中的随机数会影响生成的区块的hash值，而只有当这个hash值的前10位都是0时，才是有效的。需要耗费大量的cpu（随机碰撞）才能找到满足hash条件的随机数，这就是工作量。

>由于之后的区块是链接在该区块之后的，所以**想要更改该区块中的信息，就还需要重新完成之后所有区块的全部工作量**。  

工作量证明机制的本质则是`一CPU一票`。“大多数”的决定表达为最长的链，因为最长的链包含了最大的工作量。如果大多数的CPU为诚实的节点控制，那么诚实的链条将以最快的速度延长，并超越其他的竞争链条。  

工作量证明的难度(the proof-of-work difficulty)将采用移动平均目标的方法来确定，即令难度指向令每小时生成区块的速度为某一个预定的平均数。如果区块生成的速度过快，那么难度就会提高。

## 运行机制
1.  新的交易向全网进行广播；
2.  每一个节点都将收到的交易信息纳入一个区块中；
3.  每个节点都尝试在自己的区块中找到一个具有足够难度的工作量证明；
4.  当一个节点找到了一个工作量证明，它就向全网进行广播；
5.  当且仅当包含在该区块中的所有交易都是有效的且之前未存在过的，其他节点才认同该区块的有效性；
6.  其他节点表示他们接受该区块，而表示接受的方法，则是在跟随该区块的末尾，制造新的区块以延长该链条，而将被接受区块的随机散列值视为先于新区快的随机散列值。

如果有两个节点同时广播不同版本的新区块，那么其他节点在接收到该区块的时间上将存在先后差别。  
他们将在率先收到的区块基础上进行工作，但也会保留另外一个链条。  

该僵局（tie）的打破要等到下一个工作量证明被发现？how？

## 区块
当用户发布交易后，需要有人将交易进行确认，写到区块链中，形成新的区块。     
目前，每 10 分钟左右生成一个不超过 1 MB 大小的区块（记录了这 10 分钟内发生的验证过的交易内容），串联到最长的链尾部，每个区块的成功提交者可以得到系统 12.5 个比特币的奖励（一定区块数后才能使用），以及用户附加到交易上的支付服务费用。

<!-- ## 比特币转账
>>发送方向比特币网络发一份广播，其内容是这样的：“我要转账1 BTC，并且我能提供一段脚本，这段脚本作为钥匙可以打开这1 BTC上的锁；同时，我根据接收方的要求为这1 BTC加个新的锁”。  

>>网络各节点收到广播，运行脚本，发现确实能“开锁”。于是根据发送方的指令给这笔比特币换上一把“新锁”，这笔比特币也就有了新的主人。当接收方想使用这1 BTC时，只要能提供一段新的脚本作为钥匙打得开这把新锁就行。

脚本是一种简单的计算机语言，比如JavaScript就是一种脚本。比特币的脚本可以表述的内容非常灵活，远远超出了一对一转账的范畴。例如：A可以约定必须由收款人B和担保人C同时签名才能支配某笔比特币（担保交易），也可以约定B、C、D中任意两人签名就能支配（联名账户）；A可以约定B必须在一年后才能动用某笔比特币（延时支付），也可以约定任何人都能支配（撒钱）或者都不能支配（烧钱）。通过这套内置的脚本编程语言，你可以灵活地编写出各种各样的约定——而这其实就是简单的智能合约。


如果说区块链1.0是以比特币为代表，解决了货币和支付手段的去中心化问题，那么区块链2.0就是更宏观的对整个市场去中心化，利用区块链技术来转换许多不同的数字资产而不仅仅是比特币，通过转让来创建不同资产的价值。 -->

# 智能合约
基于区块链的智能合约包括事务处理和保存的机制，以及一个完备的状态机，用于接受和处理各种智能合约；并且事务的保存和状态处理都在区块链上完成。事务主要包含需要发送的数据；而事件则是对这些数据的描述信息。**事务及事件信息传入智能合约后**，`合约资源集合`中的资源状态会被更新，进而触发智能合约进行状态机判断。如果自动状态机中某个或某几个动作的触发条件满足，则由状态机根据预设信息选择合约动作自动执行。  

**智能合约只是一个事务处理模块和状态机构成的系统，它不产生智能合约，也不会修改智能合约；它的存在只是为了让一组复杂的、带有触发条件的数字化承诺能够按照参与者的意志，正确执行。**


# 共识机制
**共识机制一般用来保证分布式系统的一致性，`来对新增数据达成共识`。**    
对于要能容忍拜占庭错误的情况，一般包含PBFT系列、POW系列算法等。PBFT系列算法是确定的，一旦达成共识就不可逆转；而POW系列算法是不固定的，随着时间推移，被推翻的概率越来越小。    

在比特币中，指如何将全网交易数据客观记录并且不可篡改的过程。目前"三巨头"分别使用不同的共识算法（Consensus Algorithm）,比特币使用工作量证明PoW（Proof of Work），以太坊即将转换为权益证明PoS（Proof of Stake），比特股使用授权权益证明DPoS（Delegated Proof of Stake）。    

目前常用的几种共识机制     
## POW
通过计算来猜测一个数值（nonce） ，得以解决规定的 hash 问题。hash 问题具有不可逆的特点，因此，目前除了暴力计算外，还没有有效的算法进行解决。反之，如果获得符合要求的 nonce，则说明在概率上是付出了对应的算力。谁的算力多，谁最先解决问题的概率就越大。  

工作量证明机制(Proof of Work - PoW)是我们最熟知的一种共识机制。就如字面的解释，PoW就是工作越多，收益越大。这里的工作就是猜数字，谁能最快的猜出这个唯一的数字，谁就能做信息公示人。

## POS
类似现实生活中的股东机制，拥有股份越多的人越容易获取记账权。   

权益证明机制(Proof of Stake-PoS)也属于一种共识证明，它类似股权凭证和投票系统，因此也叫“股权证明算法”。由持有最多（token）的人来公示最终信息。

## PBFT
拜占庭共识算法(Byzantine Fault Tolerance- BFT)也是一种常见的共识证明。它与之前两种都不相同，BFT以计算为基础，也没有代币奖励。由链上所有人参与投票，少于（N-1）/3个节点反对时就获得公示信息的权利。**失效副本的数量不超过（n-1)/3**    

>拜占庭问题之所以难解，在于任何时候系统中都可能存在多个提案（因为提案成本很低），并且要完成最终的一致性确认过程十分困难，容易受干扰。但是一旦确认，即为最终确认。比特币的区块链网络在设计时提出了创新的 PoW（Proof of Work） 算法思路。一个是限制一段时间内整个网络中出现提案的个数（增加提案成本），另外一个是放宽对最终一致性确认的需求，约定好大家都确认并沿着已知最长的链进行拓宽。系统的最终确认是概率意义上的存在。这样，即便有人试图恶意破坏，也会付出很大的经济代价（付出超过系统一半的算力） 。

### 流程
PBFT是一种状态机副本复制算法，即服务作为状态机进行建模，状态机在分布式系统的不同节点进行副本复制。每个状态机的副本都保存了服务的状态，同时也实现了服务的操作。   

1. 每个副本节点都包含了服务的整体状态，节点的日志包含了结点所接受的消息，并且包含当前的视图编号v（每一轮主节点的产生都会有一个新的v，递增，类似于raft中的term）
2. 主节点p收到客户端发来的消息m，向所有副本节点进行广播，进行三阶段协议
3. 所有副本都执行请求并将结果发回客户端
4. 客户端需要等待f+1个不同副本节点发回相同的结果，作为整个操作的最终结果。

如果客户端没有在有限时间内收到回复，请求将向所有副本节点进行广播。如果请求已经在副本节点处理过了，副本就向客户端重发一遍执行结果。如果请求没有在副本节点处理过，该副本节点将把请求转发给主节点。如果主节点没有将该请求进行广播，那么就有认为主节点失效，如果有足够多的副本节点认为主节点失效，则会触发一次视图变更。   

[ref](https://www.jianshu.com/p/fb5edf031afd)

## 优缺点
共识算法的选择与应用场景高度相关，完全可信任的环境使用paxos 或者raft，对于联盟链这种带许可机制的可使用bft ，完全公开的链就用是pow，pos，ripple共识等。


PBFT需要结点之间相互通信，通信量是O(n^2)，不适合大规模，适合联盟链、私链。
PBFT还有个问题就是在运行之前节点必须固定并且互相知道。否则，就有可能有超过1/3的拜占庭节点，整个系统的安全性无法保证。这在public blockchain的环境下基本不可能做到的。

比特币共识不需要许可，而BFT算法需要许可（至少需要知道节点的数量和他们对应的公钥）

BFT算法可扩展性（scalability）差，比特币共识（包括POW，POS权益证明等）效率低且无法实现强一致性


# 分类
而根据所采用的共识机制的不同，区块链又分为不同的种类，每种链都有其特性和适用场合。

## 公链

公共链-真正的完全去中心的区块链，可以是pow或者pos
突出公平，这是我猜的~~~

用户不用注册就能匿名参与的链，无需授权就能访问网络的区块链。公链的任何区块对外公开，任何人都可以发送价值。比特币以太坊是著名公链，公链适合虚拟货币，电子商务互联网金融等领域。

## 联盟链

联盟链-行业内的可监管区块链，一般用BFT，例如fabric
突出监管和安全，这也是我猜的~~~

联盟链仅限于联盟成员参与，成员参与区块链运行需要按照规则获取读写记账的权限。成员需要注册才可使用。联盟链由机构成员共同维护，提供成员管理，认证，授权，监控，审计功能。由40多家银行参与的R3区块链联盟和Linux基金会成立的超级账本项目属于联盟链构架。联盟链适合机构间交易清算结算B2B场景，用于节省对账和清算成本，减少人为错误的发生。联盟链对安全性能要求比公链高。

## 私有链

私有链-机构内私有定制区块链

私有链仅在机构内使用，读写权，记账权由组织内自由定制。 私有链的价值主要是提供安全可追溯不可篡改自动执行的运算平台，必须先注册取得许可才可以访问和使用。 央行发行的数字货币就是私有链。

## 侧链

侧链-与比特币挂钩且能和比特币区块链交互的区块链

比特币的任何修改都会导致分叉，影响现有的比特币区块链，所以想要改进比特币比较困难。 一般来说要创建新的代币，是用比特币做基础重构一条链，然后在上面创建新的规则发行代币，并且`将代币的价格和比特币实时挂钩`。侧链是相对与比特币主链来说的，所有遵循侧链协议的区块链都是侧链。**侧链协议是指：`可以让比特币安全地从比特币主链转移到其他区块链，又可以从其他区块链安全地返回比特币主链的一种协议`。莱特币，达世币，zcash就是著名的侧链。**

侧链意味着比特币不仅可以在比特币区块链上流通，还可以在其他区块链上流通，其应用范围和应用前景会更加广泛；有创意的人们会研发出各种各样的应用以侧链协议与比特币主链对接，使得比特币这种基准自由货币的地位越加牢固。


## 问题
比特币中的区块记录的交易账单是什么？这些交易账单由谁产生？  
一个区块包含多少交易账单？为什么区块每十分钟产生一个，又谁控制？  
当前区块没有被矿工挖出来怎么办？  
两个节点同时广播不同记录，链分叉了如何处理，具体的？  



